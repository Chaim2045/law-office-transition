# 🔄 מדריך מיגרציית שמות שדות

**תאריך:** 2026-01-16
**מטרה:** העברת נתונים מהשמות הישנים לשמות החדשים ב-Firebase

---

## 📋 רקע

במהלך הפרויקט שינינו את שמות כל השדות מהפורמט הישן (לדוגמה: `heading_legal_processes`) לפורמט חדש וברור יותר (לדוגמה: `legal_main_title`).

**הבעיה:**
- ה-HTML כבר משתמש בשמות החדשים
- ייתכן שיש נתונים ישנים ב-Firebase עם השמות הישנים
- autosave.js החדש לא יכול למצוא את הנתונים הישנים

**הפתרון:**
סקריפט מיגרציה חד-פעמי שמעתיק נתונים מהשמות הישנים לשמות החדשים.

---

## ⚠️ אזהרות חשובות

1. **הרץ את הסקריפט רק פעם אחת!**
2. **גבה את הנתונים לפני ההרצה** (אופציונלי אבל מומלץ)
3. **הסקריפט לא מוחק את השמות הישנים** (למען הזהירות)
4. **בדוק את התוצאות לפני מחיקת השמות הישנים**

---

## 🚀 שלבי ההרצה

### שלב 1: גיבוי (אופציונלי אבל מומלץ)

לפני המיגרציה, גבה את הנתונים:

1. פתח את [Firebase Console](https://console.firebase.google.com/)
2. עבור לפרויקט שלך (`law-office-guide`)
3. Realtime Database → Export JSON
4. שמור את הקובץ במקום בטוח

### שלב 2: הכנה

1. וודא ש-Firebase מאותחל בהצלחה:
   - פתח את `index.html` בדפדפן
   - פתח Console (F12)
   - בדוק שאין שגיאות Firebase

2. וודא שיש אינטרנט (חיבור ל-Firebase)

### שלב 3: הרצת המיגרציה

#### אופציה א': דרך Console (מומלץ)

1. **פתח את האתר** בדפדפן (`index.html`)

2. **פתח Console** (F12 → Console)

3. **טען את הסקריפט:**
   ```javascript
   // העתק והדבק את כל תוכן הקובץ migrate-field-names.js
   ```

4. **הסקריפט ירוץ אוטומטית** ויציג דוח במסך:
   ```
   🚀 Starting Field Names Migration...

   📋 Field Mapping loaded: X mappings

   📥 Reading data from Firebase...
   ✅ Found Y fields in Firebase

   ✅ Migrated: old_name → new_name
   ✅ Migrated: ...
   ⏭️ Skip: ...

   ===================================================
   📊 Migration Summary:
   ===================================================
   ✅ Migrated: X
   ⏭️ Skipped: Y
   ❌ Errors: Z
   📝 Total mappings: W
   ===================================================

   ✨ Migration completed successfully!
   ```

#### אופציה ב': דרך HTML Script Tag

1. הוסף לסוף `index.html` (לפני `</body>`):
   ```html
   <!-- Migration Script - Remove after running once! -->
   <script src="migrate-field-names.js"></script>
   ```

2. פתח את `index.html` בדפדפן

3. הסקריפט ירוץ אוטומטית

4. **חשוב:** הסר את השורה אחרי ההרצה!

### שלב 4: בדיקת התוצאות

1. **רענן את הדף** (F5)

2. **בדוק שהנתונים נטענו:**
   - נווט בין הטאבים
   - וודא שהשדות מכילים את התוכן הנכון
   - בדוק ש-autosave עובד (ערוך שדה וראה אינדיקטור "נשמר")

3. **בדוק ב-Firebase Console:**
   - פתח Realtime Database
   - בדוק את `guideData`
   - צריך לראות את השמות החדשים והישנים

### שלב 5: ניקוי (אופציונלי)

לאחר שאימתת שהכל עובד, תוכל למחוק את השמות הישנים:

**אופציה א': ידנית דרך Console**

```javascript
// Run in Console AFTER verifying migration succeeded
const database = firebase.database();
const oldFields = [
  'heading_legal_processes',
  'heading_line_1886',
  'file_opening_step_1',
  // ... add all old field names
];

for (const oldField of oldFields) {
  await database.ref(`guideData/${oldField}`).remove();
  console.log(`🗑️ Deleted: ${oldField}`);
}

console.log('✅ Cleanup completed');
```

**אופציה ב': ידנית דרך Firebase Console**

1. עבור ל-Firebase Console
2. Realtime Database → `guideData`
3. מחק כל שדה עם שם ישן (אחד אחד)

---

## 📊 מה הסקריפט עושה?

1. **טוען את מיפוי השמות** (ישן → חדש)
2. **קורא את כל הנתונים** מ-Firebase
3. **לכל שם ישן:**
   - בודק אם קיים ב-Firebase
   - בודק אם השם החדש כבר קיים (אם כן, מדלג)
   - מעתיק את התוכן לשם החדש
   - **לא מוחק** את השם הישן (למען הזהירות)
4. **מציג דוח מפורט** של התהליך

---

## ❓ שאלות נפוצות

### האם המיגרציה תמחק נתונים?

**לא.** הסקריפט רק **מעתיק** נתונים. הוא לא מוחק כלום אלא אם תריץ את שלב הניקוי ידנית.

### מה קורה אם אני מריץ את הסקריפט פעמיים?

הסקריפט **חכם** - הוא בודק אם השם החדש כבר קיים. אם כן, הוא מדלג. לכן, הרצה כפולה לא תגרום לבעיה.

### מה אם יש שגיאה במהלך המיגרציה?

הסקריפט **לוכד שגיאות** ומציג אותן בקונסול. כל שדה שנכשל יירשם בדוח. תוכל לבדוק ולתקן ידנית.

### איך אני יודע שהמיגרציה הצליחה?

1. **הדוח בקונסול** צריך להציג "✅ Migrated: X" (X > 0)
2. **רענן את הדף** - הנתונים צריכים להיטען
3. **ערוך שדה** - autosave צריך לעבוד (אינדיקטור ירוק)

### האם אני צריך להריץ את זה על כל דפדפן?

**לא.** המיגרציה מתבצעת ב-Firebase עצמו. הרצה אחת מכל דפדפן מספיקה.

---

## 🔍 בדיקת בעיות נפוצות

### "Firebase is not initialized"

**פתרון:**
1. וודא שפתחת את `index.html` (לא קובץ אחר)
2. וודא שיש חיבור לאינטרנט
3. בדוק שאין שגיאות Firebase בקונסול

### "No data found in Firebase"

**משמעות:** אין נתונים ישנים למיגרציה. זה **OK** אם:
- זה התקנה חדשה
- כבר רצה מיגרציה
- כל הנתונים כבר בשמות חדשים

### "All fields skipped"

**משמעות:** כל השדות החדשים כבר קיימים. זה **OK** אם:
- כבר רצה מיגרציה פעם אחת
- הנתונים כבר בשמות חדשים

---

## 📝 תיעוד טכני

### פורמט הנתונים

**ישן (string):**
```json
{
  "heading_legal_processes": "תהליכי עבודה משפטיים"
}
```

**חדש ({content, updatedAt}):**
```json
{
  "legal_main_title": {
    "content": "תהליכי עבודה משפטיים",
    "updatedAt": 1737000000000
  }
}
```

הסקריפט תומך **בשני הפורמטים**.

### מיפוי מלא

המיפוי המלא נמצא ב-`FIELD_NAMING_MAP.md`.

הסקריפט מכיל **חלק מהמיפוי** (לדוגמה).
**TODO:** השלם את המיפוי המלא בסקריפט.

---

## 📞 עזרה

אם נתקלת בבעיה:

1. **בדוק את הקונסול** לשגיאות
2. **צלם את הדוח** (screenshot)
3. **בדוק את Firebase Console** לנתונים
4. **פנה לתמיכה** עם המידע לעיל

---

**הצלחה! 🎉**
